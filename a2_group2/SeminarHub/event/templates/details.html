{% extends "base.html" %}

{% block head_extra %}{% endblock %}

{% block content %}
<div class="container mt-4">

  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">Home</a></li>
      <li class="breadcrumb-item"><a href="{{ url_for('main.index') }}">{{ event.category or 'Category' }}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ event.title }}</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Left -->
    <div class="col-lg-8">
      <div class="mb-4">
        {% set badge_class = {'Open':'success','Inactive':'secondary','Sold Out':'danger','Cancelled':'dark'}.get(event.status, 'secondary') %}
        <span class="badge bg-{{ badge_class }} fs-6 mb-2">{{ event.status or 'Status' }}</span>

        <h1>{{ event.title }}</h1>

        <p class="text-muted">
          <i class="bi bi-calendar-event me-2"></i>
          {% if event.start_dt %}
            {{ event.start_dt.strftime('%b %d, %Y') }} |
            {{ event.start_dt.strftime('%I:%M %p') }} – {{ event.end_dt.strftime('%I:%M %p') }}
          {% else %}
            TBA
          {% endif %}
        </p>
      </div>

      <img src="{{ event.image_url or url_for('static', filename='img/placeholder-1000x400.png') }}"
           class="detail-hero" alt="{{ event.title }}">

      <div class="mb-4">
        <h3>About This Seminar</h3>
        <p>{{ event.description }}</p>

        {% if event.speaker or event.speaker_bio %}
        <h3 class="mt-4">Speaker</h3>
        <div class="d-flex align-items-center">
          <img src="https://images.unsplash.com/photo-1560250097-0b93528c311a?auto=format&fit=crop&w=100&q=80"
               class="rounded-circle me-3" width="80" height="80" alt="Speaker">
          <div>
            <h5 class="mb-0">{{ event.speaker or 'Guest Speaker' }}</h5>
            {% if event.speaker_bio %}<p class="text-muted mb-0">{{ event.speaker_bio }}</p>{% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      <div class="comment-section">
        <h4>Comments &amp; Discussions</h4>

        {% if comments and comments|length %}
          {% for c in comments %}
          <div class="comment">
            <div class="d-flex justify-content-between">
              <h6>{{ (c.user.first_name ~ ' ' ~ c.user.last_name).strip() if c.user else 'Anonymous' }}</h6>
              <small class="text-muted"data-datetime="{{ c.created_at.isoformat() }}Z">{{ c.created_at.strftime('%b %d, %Y • %I:%M %p') }}</small>
            </div>
            <p class="mb-0">{{ c.text }}</p>
          </div>
          {% endfor %}
        {% else %}
          <p class="text-muted">No comments yet. Be the first to comment.</p>
        {% endif %}

        {% if current_user.is_authenticated %}
        <form class="mt-4" method="POST" action="{{ url_for('event.add_comment', event_id=event.id) }}">
          {% if comment_form %}
            {{ comment_form.hidden_tag() }}
            <div class="mb-3">
              {{ comment_form.text.label(class="form-label") }}
              {{ comment_form.text(class="form-control", rows="3", placeholder="Join the discussion...") }}
              {% for e in comment_form.text.errors %}<div class="text-danger small">{{ e }}</div>{% endfor %}
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
          {% else %}
            <div class="mb-3">
              <label for="commentText" class="form-label">Add your comment</label>
              <textarea class="form-control" id="commentText" name="text" rows="3" placeholder="Join the discussion..."></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Post Comment</button>
          {% endif %}
        </form>
        {% else %}
          <p class="mt-3"><a href="{{ url_for('auth.login') }}">Log in</a> to post a comment.</p>
        {% endif %}
      </div>
    </div>

    <!-- Right -->
    <div class="col-lg-4">
      <div class="card shadow">
        <div class="card-body">
          <h4 class="card-title">Register for this Seminar</h4>
          <p class="text-muted"><i class="bi bi-geo-alt me-2"></i>{{ event.location or 'TBA' }}</p>
          <p class="text-muted"><i class="bi bi-ticket-perforated me-2"></i>
            {{ remaining }} of {{ event.capacity or 0 }} spots available
          </p>
          <hr>

          <form method="POST" action="{{ url_for('event.register_event', event_id=event.id) }}">
            <div class="mb-3">
              <label for="ticketCount" class="form-label">Number of tickets</label>
              <select class="form-select" id="ticketCount" name="quantity">
                {% if remaining > 0 %}
                  {% set max_tickets = [remaining, 5]|min %}
                  {% for n in range(1, max_tickets + 1) %}
                    <option value="{{ n }}">{{ n }} ticket{{ '' if n==1 else 's' }}</option>
                  {% endfor %}
                {% else %}
                  <option value="0" disabled>No tickets available</option>
                {% endif %}
              </select>
            </div>

            <div class="d-grid gap-2">
              <button class="btn btn-primary btn-lg" type="submit" {% if remaining == 0 or event.status == 'Cancelled' or event.status == 'Inactive' %}disabled{% endif %}>
                {% if remaining == 0 %}Sold Out{% else %}Register Now{% endif %}
              </button>
              <a class="btn btn-outline-secondary {% if event.status == 'Cancelled' or event.status == 'Inactive' %}disabled{% endif %}" href="#"><i class="bi bi-bookmark me-2"></i>Save for Later</a>
            </div>
          </form>
        </div>
      </div>

      <div class="card mt-4 shadow">
        <div class="card-body">
          <h5 class="card-title">Event Details</h5>
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-calendar-event me-2"></i>Date</span>
              <span>{% if event.start_dt %}{{ event.start_dt.strftime('%b %d, %Y') }}{% else %}TBA{% endif %}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-clock me-2"></i>Time</span>
              <span>{% if event.start_dt %}{{ event.start_dt.strftime('%I:%M %p') }} – {{ event.end_dt.strftime('%I:%M %p') }}{% else %}TBA{% endif %}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-geo-alt me-2"></i>Location</span>
              <span class="text-end" title="{{ event.location or 'TBA' }}">
                {% set parts = (event.location or 'TBA').replace('\n', ', ').split(',') %}
                {% for p in parts if p.strip() %}
                  {{ p.strip() }}{% if not loop.last %}<br>{% endif %}
                {% endfor %}
              </span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-people me-2"></i>Capacity</span>
              <span>{{ event.capacity or 0 }} attendees</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-ticket-perforated me-2"></i>Available</span>
              <span class="badge {% if remaining > 10 %}bg-success{% elif remaining > 0 %}bg-warning{% else %}bg-danger{% endif %}">
                {{ remaining }} tickets
              </span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <span><i class="bi bi-tag me-2"></i>Category</span>
              <span class="badge bg-primary">{{ event.category or 'General' }}</span>
            </li>
          </ul>
        </div>
      </div>

      {% if current_user.is_authenticated and event.owner_user_id == current_user.id %}
      <div class="card mt-3 shadow-sm">
        <div class="card-body">
          <h6 class="card-title mb-3">Manage Event</h6>
          <div class="d-grid gap-2">
            <a class="btn btn-primary btn-lg w-100 {% if event.status == 'Cancelled' or event.status == 'Inactive' %}disabled{% endif %}"
               href="{{ url_for('event.edit_event', event_id=event.id) }}" >
              <i class="bi bi-pencil-square me-2"></i>Edit Event
            </a>

            <form method="POST"
                  action="{{ url_for('event.cancel_event', event_id=event.id) }}"
                  onsubmit="return confirm('Cancel this event? Attendees will no longer be able to register.');"
                  class="w-100">
              <button type="submit" class="btn btn-outline-danger btn-lg w-100" {% if event.status == 'Cancelled' or event.status == 'Inactive' %}disabled{% endif %}>
                <i class="bi bi-x-circle me-2"></i>Cancel Event
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}

